

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mosaic.api &mdash; Mosaic Python Library 0.9</title>
    
    <link rel="stylesheet" href="../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Mosaic Python Library 0.9" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">Mosaic Python Library 0.9</a></div>
        <div class="rel">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for mosaic.api</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;The Mosaic Python API</span>

<span class="sd">.. moduleauthor:: Konrad Hinsen</span>

<span class="sd">This module provides abstract base classes that define the Mosaic</span>
<span class="sd">Python API and implement validation code. They also provide a few</span>
<span class="sd">convenience functions implemented in terms of the raw API.</span>

<span class="sd">Concrete implementations subclass the abstract base classes and</span>
<span class="sd">implement all the abstract properties.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c">#       Copyright (C) 2013 The Mosaic Development Team</span>
<span class="c">#</span>
<span class="c">#  Distributed under the terms of the BSD License.  The full license is in</span>
<span class="c">#  the file LICENSE.txt, distributed as part of this software.</span>
<span class="c">#-----------------------------------------------------------------------------</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractproperty</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="kn">as</span> <span class="nn">IT</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>

<span class="kn">import</span> <span class="nn">mosaic.utility</span>


<span class="c"># Mosaic version number (major, minor)</span>
<span class="c"># An increase in the minor number indicates a superset of the preceding</span>
<span class="c"># versions. An increase in the major number indicated an incompatibility</span>
<span class="c"># with preceding versions.</span>

<span class="n">MOSAIC_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>


<span class="c"># Base class for all classes that represent top-level data items,</span>
<span class="c"># i.e. items that can be stored in files, retrieved, etc.</span>

<div class="viewcode-block" id="MosaicDataItem"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicDataItem">[docs]</a><span class="k">class</span> <span class="nc">MosaicDataItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Base class for top-level data items</span>

<span class="sd">    Instances of subclasses of MosaicDataItem can be stored in files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>


<span class="c"># An atom is defined by the following characteristics:</span>
<span class="c">#</span>
<span class="c">#  - a type, which is</span>
<span class="c">#    - &#39;element&#39; for a standard atom that has a chemical element.</span>
<span class="c">#      The element symbol is the value of the name attribute.</span>
<span class="c">#    - &#39;cgparticle&#39; , for particles in coarse-grained models</span>
<span class="c">#      representing multiple atoms.</span>
<span class="c">#    - &#39;dummy&#39; for pseudo-atoms that don&#39;t physically exist,</span>
<span class="c">#      such as virtual interaction sites.</span>
<span class="c">#    - &#39;&#39; for anything else</span>
<span class="c">#</span>
<span class="c"># - a name, which is the chemical element symbol for atoms of type</span>
<span class="c">#   &#39;element&#39;, and any suitable identifier for the other types</span>
<span class="c">#</span>
<span class="c"># - a label, which identifies the atom uniquely inside its fragment</span>
<span class="c">#</span>
<span class="c"># - the number of sites, equal to the number of Cartesian coordinate</span>
<span class="c">#   sets required by the atom. It is &gt; 1 for path integral, wave</span>
<span class="c">#   functions, atoms with alternate positions in crystal structures, etc.</span>
</div>
<div class="viewcode-block" id="MosaicAtom"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicAtom">[docs]</a><span class="k">class</span> <span class="nc">MosaicAtom</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Atom inside a :py:class:`MosaicUniverse`</span>

<span class="sd">    See the :ref:`data model documentation&lt;mosaic-atom&gt;` for atoms.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

    <span class="c"># API properties</span>

    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicAtom.label"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicAtom.label">[docs]</a>    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An ASCII string not containing dots and identifying</span>
<span class="sd">        the atom uniquely inside its parent fragment.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-atom-label&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicAtom.name"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicAtom.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An ASCII string describing the type of the atom. For &#39;real&#39;</span>
<span class="sd">        atoms in the chemical sense, this must be the chemical element</span>
<span class="sd">        symbol.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-atom-name&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicAtom.type"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicAtom.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A string identifying the type of the atom.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-atom-type&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicAtom.number_of_sites"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicAtom.number_of_sites">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of sites associated with the atom.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-atom-nsites&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c"># Property shared by all atoms</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicAtom.number_of_atoms"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicAtom.number_of_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of atoms associated with the atom (always 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="c"># Equivalence test</span>
</div>
<div class="viewcode-block" id="MosaicAtom.validate_equivalence"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicAtom.validate_equivalence">[docs]</a>    <span class="k">def</span> <span class="nf">validate_equivalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :raises ValueError: if other is not equivalent to self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MosaicAtom</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not an atom&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;labels differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">label</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;names differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;types differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_sites</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">number_of_sites</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;site numbers differ: </span><span class="si">%d</span><span class="s"> != </span><span class="si">%d</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_sites</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">number_of_sites</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MosaicAtom.is_equivalent"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicAtom.is_equivalent">[docs]</a>    <span class="k">def</span> <span class="nf">is_equivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :returns: True if other is equivalent to self</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># Validation</span>
</div>
    <span class="n">_allowed_types</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;element&#39;</span><span class="p">,</span> <span class="s">&#39;cgparticle&#39;</span><span class="p">,</span> <span class="s">&#39;dummy&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="n">_elements</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Ac&#39;</span><span class="p">,</span> <span class="s">&#39;Ag&#39;</span><span class="p">,</span> <span class="s">&#39;Al&#39;</span><span class="p">,</span> <span class="s">&#39;Am&#39;</span><span class="p">,</span> <span class="s">&#39;Ar&#39;</span><span class="p">,</span> <span class="s">&#39;As&#39;</span><span class="p">,</span> <span class="s">&#39;At&#39;</span><span class="p">,</span> <span class="s">&#39;Au&#39;</span><span class="p">,</span>
                 <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;Ba&#39;</span><span class="p">,</span> <span class="s">&#39;Be&#39;</span><span class="p">,</span> <span class="s">&#39;Bh&#39;</span><span class="p">,</span> <span class="s">&#39;Bi&#39;</span><span class="p">,</span> <span class="s">&#39;Bk&#39;</span><span class="p">,</span> <span class="s">&#39;Br&#39;</span><span class="p">,</span>
                 <span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="s">&#39;Ca&#39;</span><span class="p">,</span> <span class="s">&#39;Cd&#39;</span><span class="p">,</span> <span class="s">&#39;Ce&#39;</span><span class="p">,</span> <span class="s">&#39;Cf&#39;</span><span class="p">,</span> <span class="s">&#39;Cl&#39;</span><span class="p">,</span> <span class="s">&#39;Cm&#39;</span><span class="p">,</span>
                 <span class="s">&#39;Co&#39;</span><span class="p">,</span> <span class="s">&#39;Cn&#39;</span><span class="p">,</span> <span class="s">&#39;Cr&#39;</span><span class="p">,</span> <span class="s">&#39;Cs&#39;</span><span class="p">,</span> <span class="s">&#39;Cu&#39;</span><span class="p">,</span>
                 <span class="s">&#39;D&#39;</span><span class="p">,</span> <span class="s">&#39;Db&#39;</span><span class="p">,</span> <span class="s">&#39;Ds&#39;</span><span class="p">,</span> <span class="s">&#39;Dy&#39;</span><span class="p">,</span>
                 <span class="s">&#39;Er&#39;</span><span class="p">,</span> <span class="s">&#39;Es&#39;</span><span class="p">,</span> <span class="s">&#39;Eu&#39;</span><span class="p">,</span>
                 <span class="s">&#39;F&#39;</span><span class="p">,</span> <span class="s">&#39;Fe&#39;</span><span class="p">,</span> <span class="s">&#39;Fm&#39;</span><span class="p">,</span> <span class="s">&#39;Fr&#39;</span><span class="p">,</span>
                 <span class="s">&#39;Ga&#39;</span><span class="p">,</span> <span class="s">&#39;Gd&#39;</span><span class="p">,</span> <span class="s">&#39;Ge&#39;</span><span class="p">,</span>
                 <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="s">&#39;He&#39;</span><span class="p">,</span> <span class="s">&#39;Hf&#39;</span><span class="p">,</span> <span class="s">&#39;Hg&#39;</span><span class="p">,</span> <span class="s">&#39;Ho&#39;</span><span class="p">,</span> <span class="s">&#39;Hs&#39;</span><span class="p">,</span>
                 <span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="s">&#39;In&#39;</span><span class="p">,</span> <span class="s">&#39;Ir&#39;</span><span class="p">,</span>
                 <span class="s">&#39;K&#39;</span><span class="p">,</span> <span class="s">&#39;Kr&#39;</span><span class="p">,</span>
                 <span class="s">&#39;La&#39;</span><span class="p">,</span> <span class="s">&#39;Li&#39;</span><span class="p">,</span> <span class="s">&#39;Lr&#39;</span><span class="p">,</span> <span class="s">&#39;Lu&#39;</span><span class="p">,</span>
                 <span class="s">&#39;Md&#39;</span><span class="p">,</span> <span class="s">&#39;Mg&#39;</span><span class="p">,</span> <span class="s">&#39;Mn&#39;</span><span class="p">,</span> <span class="s">&#39;Mo&#39;</span><span class="p">,</span> <span class="s">&#39;Mt&#39;</span><span class="p">,</span>
                 <span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="s">&#39;Na&#39;</span><span class="p">,</span> <span class="s">&#39;Nb&#39;</span><span class="p">,</span> <span class="s">&#39;Nd&#39;</span><span class="p">,</span> <span class="s">&#39;Ne&#39;</span><span class="p">,</span> <span class="s">&#39;Ni&#39;</span><span class="p">,</span> <span class="s">&#39;No&#39;</span><span class="p">,</span> <span class="s">&#39;Np&#39;</span><span class="p">,</span>
                 <span class="s">&#39;O&#39;</span><span class="p">,</span> <span class="s">&#39;Os&#39;</span><span class="p">,</span>
                 <span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="s">&#39;Pa&#39;</span><span class="p">,</span> <span class="s">&#39;Pb&#39;</span><span class="p">,</span> <span class="s">&#39;Pd&#39;</span><span class="p">,</span> <span class="s">&#39;Pm&#39;</span><span class="p">,</span> <span class="s">&#39;Po&#39;</span><span class="p">,</span> <span class="s">&#39;Pr&#39;</span><span class="p">,</span> <span class="s">&#39;Pt&#39;</span><span class="p">,</span> <span class="s">&#39;Pu&#39;</span><span class="p">,</span>
                 <span class="s">&#39;Ra&#39;</span><span class="p">,</span> <span class="s">&#39;Rb&#39;</span><span class="p">,</span> <span class="s">&#39;Re&#39;</span><span class="p">,</span> <span class="s">&#39;Rf&#39;</span><span class="p">,</span> <span class="s">&#39;Rg&#39;</span><span class="p">,</span> <span class="s">&#39;Rh&#39;</span><span class="p">,</span> <span class="s">&#39;Rn&#39;</span><span class="p">,</span> <span class="s">&#39;Ru&#39;</span><span class="p">,</span>
                 <span class="s">&#39;S&#39;</span><span class="p">,</span> <span class="s">&#39;Sb&#39;</span><span class="p">,</span> <span class="s">&#39;Sc&#39;</span><span class="p">,</span> <span class="s">&#39;Se&#39;</span><span class="p">,</span> <span class="s">&#39;Sg&#39;</span><span class="p">,</span> <span class="s">&#39;Si&#39;</span><span class="p">,</span> <span class="s">&#39;Sm&#39;</span><span class="p">,</span> <span class="s">&#39;Sn&#39;</span><span class="p">,</span> <span class="s">&#39;Sr&#39;</span><span class="p">,</span>
                 <span class="s">&#39;Ta&#39;</span><span class="p">,</span> <span class="s">&#39;Tb&#39;</span><span class="p">,</span> <span class="s">&#39;Tc&#39;</span><span class="p">,</span> <span class="s">&#39;Te&#39;</span><span class="p">,</span> <span class="s">&#39;Th&#39;</span><span class="p">,</span> <span class="s">&#39;Ti&#39;</span><span class="p">,</span> <span class="s">&#39;Tl&#39;</span><span class="p">,</span> <span class="s">&#39;Tm&#39;</span><span class="p">,</span>
                 <span class="s">&#39;U&#39;</span><span class="p">,</span> <span class="s">&#39;V&#39;</span><span class="p">,</span> <span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="s">&#39;Xe&#39;</span><span class="p">,</span> <span class="s">&#39;Y&#39;</span><span class="p">,</span> <span class="s">&#39;Yb&#39;</span><span class="p">,</span> <span class="s">&#39;Zn&#39;</span><span class="p">,</span> <span class="s">&#39;Zr&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_element_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">validate_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MosaicAtom.validate"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicAtom.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that the object satisfies the constraints of the</span>
<span class="sd">        Mosaic data model.</span>

<span class="sd">        :raises ValueError: if the object is not valid Mosaic data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validate_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s">&quot;Atom.label&quot;</span><span class="p">)</span>
        <span class="n">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_types</span><span class="p">,</span> <span class="s">&quot;Atom type&quot;</span><span class="p">)</span>
        <span class="n">validate_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Atom.name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&#39;element&#39;</span><span class="p">:</span>
            <span class="n">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">,</span> <span class="s">&quot;Atom element&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_sites</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Atom.number_of_sites must be an integer&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_sites</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Atom.number_of_sites must be positive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Atom.number_of_atoms must be 1&quot;</span><span class="p">)</span>


<span class="c"># A fragment describes a node in the tree defining the chemical</span>
<span class="c"># structure of the molecules. It can represent a molecule,</span>
<span class="c"># a supermolecule, or part of a molecule. A fragment is defined</span>
<span class="c"># by</span>
<span class="c">#</span>
<span class="c">#  - a species, which is a text string describing the chemical</span>
<span class="c">#    nature of the fragment</span>
<span class="c">#</span>
<span class="c">#  - a label, which describes the role of the fragment inside its</span>
<span class="c">#    parent structure, and must be unique within that parent structure</span>
<span class="c">#</span>
<span class="c">#  - a list of sub-fragments</span>
<span class="c">#</span>
<span class="c">#  - a list of atoms</span>
<span class="c">#</span>
<span class="c">#  - a list of bonds</span>
<span class="c">#</span>
<span class="c">#  - the boolean flag is_polymer. Polymer fragments have an emtpy</span>
<span class="c">#    atom list and an additional attribute &#39;polymer_type&#39; whose</span>
<span class="c">#    allowed values are</span>
<span class="c">#      - &#39;polypeptide&#39;, for a peptide chain</span>
<span class="c">#      - &#39;polyribonucleotide&#39;, for an RNA chain</span>
<span class="c">#      - &#39;polydeoxyribonucleotide&#39;, for a DNA chain</span>
<span class="c">#      - &#39;polynucleotide&#39;, for a chain that can contain</span>
<span class="c">#        nucleotides with either type of sugar</span>
<span class="c">#      - the empty string, for any other polymer</span>
</div></div>
<div class="viewcode-block" id="MosaicFragment"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment">[docs]</a><span class="k">class</span> <span class="nc">MosaicFragment</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Fragment inside a :py:class:`MosaicUniverse`</span>

<span class="sd">    See the :ref:`data model documentation&lt;mosaic-fragment&gt;` for fragments.</span>

<span class="sd">    Fragments implement the Mapping interface. Valid keys are strings</span>
<span class="sd">    identifying atoms or sub-fragments, using dots to separate subsequent</span>
<span class="sd">    labels. For polymer fragments, integer keys are valid as well to refer</span>
<span class="sd">    to a specific sub-fragment in the chain.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># API properties</span>

    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicFragment.label"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.label">[docs]</a>    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An ASCII string not containing dots and identifying</span>
<span class="sd">        the fragment uniquely inside its parent fragment.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-fragment-label&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicFragment.species"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.species">[docs]</a>    <span class="k">def</span> <span class="nf">species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An ASCII string describing the species of the fragment</span>
<span class="sd">        (e.g. what kind of molecule or moiety it represents).</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-fragment-species&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicFragment.fragments"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.fragments">[docs]</a>    <span class="k">def</span> <span class="nf">fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sequence of sub-fragments, may be empty.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-fragment-fragments&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicFragment.atoms"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.atoms">[docs]</a>    <span class="k">def</span> <span class="nf">atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sequence of atoms, may be empty.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-fragment-atoms&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicFragment.bonds"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.bonds">[docs]</a>    <span class="k">def</span> <span class="nf">bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sequence of bonds, may be empty. Each bond is</span>
<span class="sd">        repreented by a tuple (atom_ref_1, atom_ref_2, bond_order).</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-fragment-bonds&gt;`</span>
<span class="sd">        and the :ref:`bond reference documentation&lt;mosaic-bonds&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicFragment.is_polymer"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.is_polymer">[docs]</a>    <span class="k">def</span> <span class="nf">is_polymer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the fragment is a polymer.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-fragment-polymer&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicFragment.polymer_type"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.polymer_type">[docs]</a>    <span class="k">def</span> <span class="nf">polymer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String identifying the polymer type if is_polymer is true.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-fragment-polymer&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c"># Properties that can be computed in terms of the API properties</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicFragment.number_of_atoms"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.number_of_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of atoms in the fragment (including the atoms</span>
<span class="sd">        in sub-fragments).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> \
               <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicFragment.number_of_sites"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.number_of_sites">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of sites associated with the fragment, i.e.</span>
<span class="sd">        the sum of the numbers of sites of all the fragment&#39;s atoms,</span>
<span class="sd">        including those of sub-fragments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">number_of_sites</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> \
               <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">number_of_sites</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicFragment.number_of_bonds"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.number_of_bonds">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of bonds associated with the fragment,</span>
<span class="sd">        including the bonds inside sub-fragments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">number_of_bonds</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> \
               <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>

    <span class="c"># Equivalence test</span>
</div>
<div class="viewcode-block" id="MosaicFragment.validate_equivalence"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.validate_equivalence">[docs]</a>    <span class="k">def</span> <span class="nf">validate_equivalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :raises ValueError: if other is not equivalent to self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MosaicFragment</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a fragment&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;labels differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">label</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;species differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">species</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_polymer</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">is_polymer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a polymer&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymer_type</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">polymer_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;polymer types differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymer_type</span><span class="p">),</span>
                                    <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">polymer_type</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">fragments</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bond_set</span><span class="p">()</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_bond_set</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;bonds differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bond_set</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_bond_set</span><span class="p">)))</span>
</div>
    <span class="k">def</span> <span class="nf">_bond_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">((</span><span class="nb">frozenset</span><span class="p">((</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)),</span> <span class="n">order</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>

<div class="viewcode-block" id="MosaicFragment.is_equivalent"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.is_equivalent">[docs]</a>    <span class="k">def</span> <span class="nf">is_equivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :returns: True if other is equivalent to self</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># Validation</span>
</div>
    <span class="n">_polymer_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                      <span class="s">&#39;polypeptide&#39;</span><span class="p">,</span>
                      <span class="s">&#39;polyribonucleotide&#39;</span><span class="p">,</span>
                      <span class="s">&#39;polydeoxyribonucleotide&#39;</span><span class="p">,</span>
                      <span class="s">&#39;polynucleotide&#39;</span><span class="p">]</span>

    <span class="n">_bond_orders</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">,</span> <span class="s">&#39;double&#39;</span><span class="p">,</span> <span class="s">&#39;triple&#39;</span><span class="p">,</span> <span class="s">&#39;quadruple&#39;</span><span class="p">,</span> <span class="s">&#39;aromatic&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="MosaicFragment.validate"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that the object satisfies the constraints of the</span>
<span class="sd">        Mosaic data model.</span>

<span class="sd">        :raises ValueError: if the object is not valid Mosaic data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validate_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s">&quot;Fragment.label&quot;</span><span class="p">)</span>
        <span class="n">validate_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="s">&quot;Fragment.species&quot;</span><span class="p">)</span>
        <span class="n">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_polymer</span><span class="p">,</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span> <span class="s">&quot;Fragment.is_polymer&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_polymer</span><span class="p">:</span>
            <span class="n">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymer_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polymer_types</span><span class="p">,</span>
                           <span class="s">&quot;Fragment.polymer_type&quot;</span><span class="p">)</span>
        <span class="n">validate_sequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">,</span> <span class="n">MosaicFragment</span><span class="p">,</span> <span class="s">&quot;Fragment.fragments&quot;</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Label </span><span class="si">%s</span><span class="s"> occurs more than once&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="n">validate_sequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">MosaicAtom</span><span class="p">,</span> <span class="s">&quot;Fragment.atoms&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Label </span><span class="si">%s</span><span class="s"> occurs more than once&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">property</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;number_of_atoms&#39;</span><span class="p">,</span>
                         <span class="s">&#39;number_of_sites&#39;</span><span class="p">,</span>
                         <span class="s">&#39;number_of_bonds&#39;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">MosaicFragment</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">reference</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Fragment.</span><span class="si">%s</span><span class="s"> is </span><span class="si">%s</span><span class="s">, should be </span><span class="si">%s</span><span class="s">&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">reference</span><span class="p">)))</span>

    <span class="c"># Methods based on API properties</span>
</div>
<div class="viewcode-block" id="MosaicFragment.recursive_atom_iterator"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.recursive_atom_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">recursive_atom_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An iterator over the atoms in the fragment, including the</span>
<span class="sd">        atoms in sub-fragments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">IT</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">IT</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">recursive_atom_iterator</span><span class="p">()</span>
                                               <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">),</span>
                        <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MosaicFragment.recursive_atom_path_iterator"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.recursive_atom_path_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">recursive_atom_path_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An iterator over the atom paths in the fragment, including the</span>
<span class="sd">        atoms in sub-fragments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span>
            <span class="k">for</span> <span class="n">ap</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">recursive_atom_path_iterator</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">l</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ap</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">a</span><span class="o">.</span><span class="n">label</span>
</div>
<div class="viewcode-block" id="MosaicFragment.recursive_bond_iterator"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.recursive_bond_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">recursive_bond_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An iterator over the bonds in the fragment, including the</span>
<span class="sd">        bonds in sub-fragments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span>
            <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">recursive_bond_iterator</span><span class="p">():</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">a1</span><span class="p">,</span> <span class="n">l</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">a2</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">b</span>
</div>
<div class="viewcode-block" id="MosaicFragment.site_to_atom_index_mapping"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.site_to_atom_index_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">site_to_atom_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: an array whose element [s] is the atom index</span>
<span class="sd">                  corresponding to site index s.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">number_of_sites</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_atom_iterator</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="p">)),</span> <span class="n">ns</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_atom_to_site_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">number_of_sites</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_atom_iterator</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>

<div class="viewcode-block" id="MosaicFragment.atom_to_site_index_mapping"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicFragment.atom_to_site_index_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">atom_to_site_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: an array whose element [s] is the site index</span>
<span class="sd">                  corresponding to the first site of the atom with</span>
<span class="sd">                  atom index s.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atom_to_site_index_mapping</span><span class="p">()</span>
        <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">m</span>

    <span class="c"># Mapping interface</span>
</div>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_polymer</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="c"># A rather inefficient implementation of substructure selection</span>
        <span class="c"># using only the public API elements. Concrete implementations</span>
        <span class="c"># can do better.</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">f</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">a</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: the number of sub-elements, i.e. atoms and sub-fragments</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over sub-fragments first, then over the fragment&#39;s atoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">a</span><span class="o">.</span><span class="n">label</span>

    <span class="c"># Override some methods from collections.Mapping for efficiency</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span>

    <span class="k">def</span> <span class="nf">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">IT</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">),</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>


<span class="c"># A universe description consists of</span>
<span class="c">#</span>
<span class="c"># - the cell shape</span>
<span class="c">#</span>
<span class="c"># - a list of symmetry transformations</span>
<span class="c">#</span>
<span class="c"># - the chemical structure of its contents</span>
<span class="c">#</span>
<span class="c"># - a label indicating additional conventions that this universe</span>
<span class="c">#   conforms to, in particular naming conventions for atoms and molecules</span>
</div>
<div class="viewcode-block" id="MosaicUniverse"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse">[docs]</a><span class="k">class</span> <span class="nc">MosaicUniverse</span><span class="p">(</span><span class="n">MosaicDataItem</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Universe</span>

<span class="sd">    See the :ref:`data model documentation&lt;mosaic-universe&gt;` for universes.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># API properties</span>

    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicUniverse.cell_shape"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.cell_shape">[docs]</a>    <span class="k">def</span> <span class="nf">cell_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A string identifying the cell shape.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-universe-cell-shape&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicUniverse.symmetry_transformations"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.symmetry_transformations">[docs]</a>    <span class="k">def</span> <span class="nf">symmetry_transformations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A sequence of symmetry transformations, possibly empty.</span>
<span class="sd">        Each symmetry tranformation is defined by a two-element tuple,</span>
<span class="sd">        whose first item is a rotation matrix and whose second item</span>
<span class="sd">        is a translation vector.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-universe-symmetry&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicUniverse.convention"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.convention">[docs]</a>    <span class="k">def</span> <span class="nf">convention</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An ASCII string naming the conventions used inside the</span>
<span class="sd">        definitions of fragements and atoms.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-universe-convention&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicUniverse.molecules"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.molecules">[docs]</a>    <span class="k">def</span> <span class="nf">molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A sequence of molecule specifications. Each element is a</span>
<span class="sd">        two-element tuple, whose first element is a :py:class:`MosaicFragment`</span>
<span class="sd">        and whose second element is an integer specifying the number of</span>
<span class="sd">        copies of the molecule.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-universe-molecules&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c"># Properties that can be computed in terms of the API properties</span>
</div>
    <span class="n">_cell_parameter_array_shapes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;infinite&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span>
        <span class="s">&#39;cube&#39;</span><span class="p">:</span> <span class="p">(),</span>
        <span class="s">&#39;cuboid&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span>
        <span class="s">&#39;parallelepiped&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)}</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicUniverse.cell_parameter_array_shape"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.cell_parameter_array_shape">[docs]</a>    <span class="k">def</span> <span class="nf">cell_parameter_array_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The shape of a valid cell_parameters array</span>
<span class="sd">        in a :py:class:`MosaicConfiguration`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_parameter_array_shapes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_shape</span><span class="p">]</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicUniverse.number_of_molecules"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.number_of_molecules">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The number of molecules in the universe.&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicUniverse.number_of_atoms"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.number_of_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The number of atoms in the universe.&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicUniverse.number_of_sites"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.number_of_sites">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The number of sites in the universe.&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">number_of_sites</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicUniverse.number_of_bonds"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.number_of_bonds">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The number of bonds in the universe.&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">number_of_bonds</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicUniverse.number_of_template_atoms"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.number_of_template_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_template_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of template atoms in the universe, i.e. the</span>
<span class="sd">        total number of atoms in all fragment definitions. It is</span>
<span class="sd">        equal to the number of atoms iff all molecule repetition</span>
<span class="sd">        counts are 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicUniverse.number_of_template_sites"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.number_of_template_sites">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_template_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of template sites in the universe, i.e. the</span>
<span class="sd">        total number of sites in all fragment definitions. It is</span>
<span class="sd">        equal to the number of sites iff all molecule repetition</span>
<span class="sd">        counts are 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">number_of_sites</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">)</span>

    <span class="c"># Equivalence test</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.validate_equivalence"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.validate_equivalence">[docs]</a>    <span class="k">def</span> <span class="nf">validate_equivalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :raises ValueError: if other is not equivalent to self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MosaicUniverse</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a universe&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_shape</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">cell_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;cell shapes differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_shape</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">cell_shape</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convention</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">convention</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;naming conventions differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convention</span><span class="p">),</span>
                                <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">convention</span><span class="p">)))</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">),</span> <span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry_transformations</span><span class="p">,</span>
                                      <span class="n">other</span><span class="o">.</span><span class="n">symmetry_transformations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r1</span> <span class="o">!=</span> <span class="n">r2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;rotation matrices differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">r2</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">t1</span> <span class="o">!=</span> <span class="n">t2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;translation vectors differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">t2</span><span class="p">)))</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="n">sc</span><span class="p">),</span> <span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">oc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">molecules</span><span class="p">):</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sc</span> <span class="o">!=</span> <span class="n">oc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;molecule counts differ: </span><span class="si">%d</span><span class="s"> != </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">oc</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.is_equivalent"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.is_equivalent">[docs]</a>    <span class="k">def</span> <span class="nf">is_equivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :returns: True if other is equivalent to self</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># Validation</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.validate"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that the object satisfies the constraints of the</span>
<span class="sd">        Mosaic data model.</span>

<span class="sd">        :raises ValueError: if the object is not valid Mosaic data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_shape</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_cell_parameter_array_shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                       <span class="s">&quot;Universe.cell_shape&quot;</span><span class="p">)</span>
        <span class="n">validate_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convention</span><span class="p">,</span> <span class="s">&quot;Universe.convention&quot;</span><span class="p">)</span>
        <span class="n">validate_sequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry_transformations</span><span class="p">,</span>
                          <span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,</span>
                          <span class="s">&quot;Universe.symmetry_transformations&quot;</span><span class="p">,</span>
                          <span class="p">((</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="s">&quot;must have length 2&quot;</span><span class="p">),</span>
                           <span class="p">(</span><span class="k">lambda</span> <span class="n">rot</span><span class="p">,</span> <span class="n">trans</span><span class="p">:</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span> <span class="s">&quot;shape&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="s">&quot;rotation matrix shape is not (3, 3)&quot;</span><span class="p">),</span>
                           <span class="p">(</span><span class="k">lambda</span> <span class="n">rot</span><span class="p">,</span> <span class="n">trans</span><span class="p">:</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="s">&quot;shape&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span>
                            <span class="s">&quot;translation vector shape is not (3,)&quot;</span><span class="p">),</span>
                           <span class="p">(</span><span class="k">lambda</span> <span class="n">rot</span><span class="p">,</span> <span class="n">trans</span><span class="p">:</span>
                            <span class="n">rot</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">N</span><span class="o">.</span><span class="n">float64</span>
                            <span class="ow">and</span> <span class="n">trans</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">N</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                            <span class="s">&quot;rotation and translation must be float64&quot;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_shape</span> <span class="o">==</span> <span class="s">&quot;infinite&quot;</span> \
           <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry_transformations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Symmetry transformations are allowed &quot;</span>
                             <span class="s">&quot;only in periodic universes&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Molecule count must be an integer&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Molecule count must be positive&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">property</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;cell_parameter_array_shape&#39;</span><span class="p">,</span>
                         <span class="s">&#39;number_of_molecules&#39;</span><span class="p">,</span> <span class="s">&#39;number_of_atoms&#39;</span><span class="p">,</span>
                         <span class="s">&#39;number_of_sites&#39;</span><span class="p">,</span> <span class="s">&#39;number_of_bonds&#39;</span><span class="p">,</span>
                         <span class="s">&#39;number_of_template_atoms&#39;</span><span class="p">,</span>
                         <span class="s">&#39;number_of_template_sites&#39;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">MosaicUniverse</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">reference</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Universe.</span><span class="si">%s</span><span class="s"> is </span><span class="si">%s</span><span class="s">, should be </span><span class="si">%s</span><span class="s">&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">reference</span><span class="p">)))</span>

    <span class="c"># Methods based on API properties</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.recursive_atom_iterator"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.recursive_atom_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">recursive_atom_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An iterator over the atoms in the universe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fragment</span><span class="o">.</span><span class="n">recursive_atom_iterator</span><span class="p">():</span>
                    <span class="k">yield</span> <span class="n">a</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.bond_index_array"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.bond_index_array">[docs]</a>    <span class="k">def</span> <span class="nf">bond_index_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an integer array of shape (N, 2), where N</span>
<span class="sd">        is the total number of bonds in the universe. The entries</span>
<span class="sd">        [i, 0] and [i, 1] refer to the two atoms that are connected</span>
<span class="sd">        by bond i. The entry [i, 0] is smaller than the entry [i, 1].</span>

<span class="sd">        :returns: the bond index array</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">f_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fragment</span><span class="o">.</span><span class="n">recursive_atom_path_iterator</span><span class="p">())</span>
            <span class="n">f_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">((</span><span class="n">f_paths</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a1</span><span class="p">),</span> <span class="n">f_paths</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a2</span><span class="p">)))</span>
                       <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">fragment</span><span class="o">.</span><span class="n">recursive_bond_iterator</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                <span class="n">bonds</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">natoms</span><span class="o">+</span><span class="n">a1</span><span class="p">,</span> <span class="n">natoms</span><span class="o">+</span><span class="n">a2</span><span class="p">)</span> <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">f_bonds</span><span class="p">])</span>
                <span class="n">natoms</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f_paths</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.site_to_atom_index_mapping"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.site_to_atom_index_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">site_to_atom_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: an array whose element [s] is the atom index</span>
<span class="sd">                  corresponding to site index s.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">per_fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">site_to_atom_index_mapping</span><span class="p">()</span>
            <span class="n">f_natoms</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">number_of_atoms</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                <span class="n">total</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_fragment</span> <span class="o">+</span> <span class="n">natoms</span><span class="p">)</span>
                <span class="n">natoms</span> <span class="o">+=</span> <span class="n">f_natoms</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.atom_to_site_index_mapping"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.atom_to_site_index_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">atom_to_site_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: an array whose element [s] is the site index</span>
<span class="sd">                  corresponding to the first site of the atom with</span>
<span class="sd">                  atom index s.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nsites</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">per_fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">_atom_to_site_index_mapping</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                <span class="n">total</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_fragment</span> <span class="o">+</span> <span class="n">nsites</span><span class="p">)</span>
                <span class="n">nsites</span> <span class="o">+=</span> <span class="n">per_fragment</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
        <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">m</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.template_site_to_template_atom_index_mapping"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.template_site_to_template_atom_index_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">template_site_to_template_atom_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: an array whose element [s] is the template atom index</span>
<span class="sd">                  corresponding to template site index s.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">per_fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">site_to_atom_index_mapping</span><span class="p">()</span>
            <span class="n">f_natoms</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">number_of_atoms</span>
            <span class="n">total</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_fragment</span> <span class="o">+</span> <span class="n">natoms</span><span class="p">)</span>
            <span class="n">natoms</span> <span class="o">+=</span> <span class="n">f_natoms</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.site_to_template_index_mapping"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.site_to_template_index_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">site_to_template_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: an array whose element [s] is the template site index</span>
<span class="sd">                  corresponding to site index s.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ntsites</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">f_nsites</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">number_of_sites</span>
            <span class="n">per_fragment</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">f_nsites</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                <span class="n">total</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_fragment</span> <span class="o">+</span> <span class="n">ntsites</span><span class="p">)</span>
            <span class="n">ntsites</span> <span class="o">+=</span> <span class="n">f_nsites</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MosaicUniverse.atom_to_template_index_mapping"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicUniverse.atom_to_template_index_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">atom_to_template_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: an array whose element [s] is the template atom index</span>
<span class="sd">                  corresponding to atom index s.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ntatoms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
            <span class="n">f_natoms</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">number_of_atoms</span>
            <span class="n">per_fragment</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">f_natoms</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                <span class="n">total</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_fragment</span> <span class="o">+</span> <span class="n">ntatoms</span><span class="p">)</span>
            <span class="n">ntatoms</span> <span class="o">+=</span> <span class="n">f_natoms</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>


<span class="c"># Properties associate a value with each atom or site in a</span>
<span class="c"># universe. The value can be an array of any shape and any element</span>
<span class="c"># type, but shape and element type are the same for all atoms.</span>
<span class="c"># Properties also have a name that describes the quantitity they</span>
<span class="c"># store, and the units of this quantity.</span>
<span class="c">#</span>
<span class="c"># Properties whose type starts with &quot;template&quot; are defined only for</span>
<span class="c"># each atom or site in the molecule templates, not for each individual</span>
<span class="c"># molecular instance. They are used for properties that are the same</span>
<span class="c"># for all molecules of the same type (e.g. atomic mass).</span>
</div></div>
<div class="viewcode-block" id="MosaicProperty"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty">[docs]</a><span class="k">class</span> <span class="nc">MosaicProperty</span><span class="p">(</span><span class="n">MosaicDataItem</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Property</span>

<span class="sd">    See the :ref:`data model documentation&lt;mosaic-property&gt;` for properties.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># API properties</span>

    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicProperty.type"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A string identifying the type of the property.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-property-type&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicProperty.name"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An ASCII string describing the property.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-property-name&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicProperty.units"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty.units">[docs]</a>    <span class="k">def</span> <span class="nf">units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A string identifying the physical units of the property.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-property-units&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicProperty.universe"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty.universe">[docs]</a>    <span class="k">def</span> <span class="nf">universe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The :py:class:`MosaicUniverse` for which the property is defined.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicProperty.data"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty.data">[docs]</a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An array containing the property&#39;s values.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-property-data&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c"># Properties that can be computed in terms of the API properties</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicProperty.element_shape"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty.element_shape">[docs]</a>    <span class="k">def</span> <span class="nf">element_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The shape of the sub-array containing the propery for one</span>
<span class="sd">        atom or site.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c"># Equivalence test</span>
</div>
<div class="viewcode-block" id="MosaicProperty.validate_equivalence"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty.validate_equivalence">[docs]</a>    <span class="k">def</span> <span class="nf">validate_equivalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :raises ValueError: if other is not equivalent to self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MosaicProperty</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a property&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;types differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;names differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;units differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">units</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element_shape</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">element_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;element shapes differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_shape</span><span class="p">),</span>
                                <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">element_shape</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;data dtypes differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;data arrays differ&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MosaicProperty.is_equivalent"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty.is_equivalent">[docs]</a>    <span class="k">def</span> <span class="nf">is_equivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :returns: True if other is equivalent to self</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># Validation</span>
</div>
    <span class="n">_allowed_dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                       <span class="n">N</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
                       <span class="n">N</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                       <span class="n">N</span><span class="o">.</span><span class="n">bool</span><span class="p">]</span>

    <span class="n">_allowed_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;atom&quot;</span><span class="p">,</span> <span class="s">&quot;site&quot;</span><span class="p">,</span> <span class="s">&quot;template_atom&quot;</span><span class="p">,</span> <span class="s">&quot;template_site&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="MosaicProperty.validate"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicProperty.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that the object satisfies the constraints of the</span>
<span class="sd">        Mosaic data model.</span>

<span class="sd">        :raises ValueError: if the object is not valid Mosaic data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_types</span><span class="p">,</span> <span class="s">&quot;Property.type&quot;</span><span class="p">)</span>
        <span class="n">validate_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Property.name&quot;</span><span class="p">)</span>
        <span class="n">validate_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="s">&quot;Property.units&quot;</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">MosaicUniverse</span><span class="p">,</span> <span class="s">&quot;Property.universe&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">el_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element_shape</span>
        <span class="n">data_shape</span> <span class="o">=</span> <span class="p">({</span><span class="s">&quot;atom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_atoms</span><span class="p">,</span>
                       <span class="s">&quot;site&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_sites</span><span class="p">,</span>
                       <span class="s">&quot;template_atom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_template_atoms</span><span class="p">,</span>
                       <span class="s">&quot;template_site&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_template_sites</span><span class="p">,</span>
                       <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">],)</span> <span class="o">+</span> <span class="n">el_shape</span>
        <span class="n">validate_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                       <span class="n">data_shape</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_dtypes</span><span class="p">,</span>
                       <span class="s">&quot;Property.data&quot;</span><span class="p">)</span>


<span class="c"># Labels associate a text string with each atom or site in a</span>
<span class="c"># universe. They work much like properties, except for having a string</span>
<span class="c"># value. Labels are a separate data item because the differences</span>
<span class="c"># compared to numerical properties (no element shape, no unit) would</span>
<span class="c"># make validation of a common data item type too complicated.</span>
<span class="c">#</span>
<span class="c"># Labels whose type starts with &quot;template&quot; are defined only for</span>
<span class="c"># each atom or site in the molecule templates, not for each individual</span>
<span class="c"># molecular instance.</span>
</div></div>
<div class="viewcode-block" id="MosaicLabel"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicLabel">[docs]</a><span class="k">class</span> <span class="nc">MosaicLabel</span><span class="p">(</span><span class="n">MosaicDataItem</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Label</span>

<span class="sd">    See the :ref:`data model documentation&lt;mosaic-label&gt;` for labels.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># API properties</span>

    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicLabel.type"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicLabel.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A string identifying the type of the label.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-label-type&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicLabel.name"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicLabel.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An ASCII string describing the label.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-label-name&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicLabel.universe"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicLabel.universe">[docs]</a>    <span class="k">def</span> <span class="nf">universe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The :py:class:`MosaicUniverse` for which the property is defined.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicLabel.strings"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicLabel.strings">[docs]</a>    <span class="k">def</span> <span class="nf">strings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A sequence of strings representing a label for each atom or site.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-label-strings&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c"># Equivalence test</span>
</div>
<div class="viewcode-block" id="MosaicLabel.validate_equivalence"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicLabel.validate_equivalence">[docs]</a>    <span class="k">def</span> <span class="nf">validate_equivalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :raises ValueError: if other is not equivalent to self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MosaicLabel</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a label&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;types differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;names differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">strings</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s1</span> <span class="o">!=</span> <span class="n">s2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;labels differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s1</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s2</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="MosaicLabel.is_equivalent"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicLabel.is_equivalent">[docs]</a>    <span class="k">def</span> <span class="nf">is_equivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :returns: True if other is equivalent to self</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># Validation</span>
</div>
    <span class="n">_allowed_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;atom&quot;</span><span class="p">,</span> <span class="s">&quot;site&quot;</span><span class="p">,</span> <span class="s">&quot;template_atom&quot;</span><span class="p">,</span> <span class="s">&quot;template_site&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="MosaicLabel.validate"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicLabel.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that the object satisfies the constraints of the</span>
<span class="sd">        Mosaic data model.</span>

<span class="sd">        :raises ValueError: if the object is not valid Mosaic data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_types</span><span class="p">,</span> <span class="s">&quot;Label.type&quot;</span><span class="p">)</span>
        <span class="n">validate_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Label.name&quot;</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">MosaicUniverse</span><span class="p">,</span> <span class="s">&quot;Label.universe&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">validate_sequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&quot;Label.strings&quot;</span><span class="p">)</span>
        <span class="n">nstrings</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;atom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_atoms</span><span class="p">,</span>
                    <span class="s">&quot;site&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_sites</span><span class="p">,</span>
                    <span class="s">&quot;template_atom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_template_atoms</span><span class="p">,</span>
                    <span class="s">&quot;template_site&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_template_sites</span><span class="p">,</span>
                    <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nstrings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;incorrect number of strings&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">:</span>
            <span class="n">validate_ascii_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;label&quot;</span><span class="p">)</span>


<span class="c"># A configuration specifies a coordinate for each site and</span>
<span class="c"># the shape and size of the cell.</span>
</div></div>
<div class="viewcode-block" id="MosaicConfiguration"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicConfiguration">[docs]</a><span class="k">class</span> <span class="nc">MosaicConfiguration</span><span class="p">(</span><span class="n">MosaicDataItem</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Configuration</span>

<span class="sd">    See the :ref:`data model documentation&lt;mosaic-configuration&gt;`</span>
<span class="sd">    for configurations.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># API properties</span>

    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicConfiguration.universe"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicConfiguration.universe">[docs]</a>    <span class="k">def</span> <span class="nf">universe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The :py:class:`MosaicUniverse` for which the property is defined.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicConfiguration.cell_parameters"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicConfiguration.cell_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">cell_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An array containing the parameters defining the shape and size</span>
<span class="sd">        of the cell.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-configuration-cp&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicConfiguration.positions"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicConfiguration.positions">[docs]</a>    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An array containing an (x, y, z) position for each site.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-configuration-pos&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c"># Methods based on API properties</span>
</div>
<div class="viewcode-block" id="MosaicConfiguration.lattice_vectors"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicConfiguration.lattice_vectors">[docs]</a>    <span class="k">def</span> <span class="nf">lattice_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: a sequence of arrays of shape (3,) containing the lattice</span>
<span class="sd">                  vectors for the simulation cell.</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;infinite&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(),</span>
                <span class="s">&#39;cube&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                   <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                   <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="p">)),</span>
                <span class="s">&#39;cuboid&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                     <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                     <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="p">)),</span>
                <span class="s">&#39;parallelepiped&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p</span><span class="p">),</span>
                <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">cell_shape</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">)</span>

    <span class="c"># Equivalence test</span>
</div>
<div class="viewcode-block" id="MosaicConfiguration.validate_equivalence"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicConfiguration.validate_equivalence">[docs]</a>    <span class="k">def</span> <span class="nf">validate_equivalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :raises ValueError: if other is not equivalent to self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MosaicConfiguration</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a configuration&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;cell parameters differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">),</span>
                                <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">cell_parameters</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;cell parameter dtypes differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">cell_parameters</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;position dtypes differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;position arrays differ&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MosaicConfiguration.is_equivalent"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicConfiguration.is_equivalent">[docs]</a>    <span class="k">def</span> <span class="nf">is_equivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :returns: True if other is equivalent to self</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># Validation</span>
</div>
    <span class="n">_allowed_dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>

<div class="viewcode-block" id="MosaicConfiguration.validate"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicConfiguration.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that the object satisfies the constraints of the</span>
<span class="sd">        Mosaic data model.</span>

<span class="sd">        :raises ValueError: if the object is not valid Mosaic data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">MosaicUniverse</span><span class="p">,</span> <span class="s">&quot;Configuration.universe&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">validate_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">cell_parameter_array_shape</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_dtypes</span><span class="p">,</span>
                       <span class="s">&quot;Configuration.cell_parameters&quot;</span><span class="p">)</span>
        <span class="n">validate_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_sites</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_dtypes</span><span class="p">,</span>
                       <span class="s">&quot;Configuration.positions&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Configuration.cell_parameters and &quot;</span>
                             <span class="s">&quot;Configuration.positions must have same dtypes&quot;</span><span class="p">)</span>


<span class="c"># Selections specify a subset of atoms or sites, either in the templates</span>
<span class="c"># or in the molecules of a universe.</span>
</div></div>
<div class="viewcode-block" id="MosaicSelection"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicSelection">[docs]</a><span class="k">class</span> <span class="nc">MosaicSelection</span><span class="p">(</span><span class="n">MosaicDataItem</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Selection</span>

<span class="sd">    See the :ref:`data model documentation&lt;mosaic-selection&gt;` for selections.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># API properties</span>

    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicSelection.type"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicSelection.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A string identifying the type of the selection.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-selection-type&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicSelection.universe"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicSelection.universe">[docs]</a>    <span class="k">def</span> <span class="nf">universe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The :py:class:`MosaicUniverse` for which the selection is defined.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@abstractproperty</span>
<div class="viewcode-block" id="MosaicSelection.indices"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicSelection.indices">[docs]</a>    <span class="k">def</span> <span class="nf">indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An array containing the indices of the contained atoms or sites.</span>
<span class="sd">        See the :ref:`data model documentation&lt;mosaic-selection-indices&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c"># Properties that can be computed in terms of the API properties</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicSelection.number_of_atoms"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicSelection.number_of_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of atoms in the selection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;atom&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;template_atom&quot;</span><span class="p">:</span>
            <span class="n">natoms</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ntatoms</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
                <span class="n">nta</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">number_of_atoms</span>
                <span class="n">natoms</span> <span class="o">+=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">indices</span> <span class="o">&gt;=</span> <span class="n">ntatoms</span><span class="p">)</span>
                                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">indices</span> <span class="o">&lt;</span> <span class="n">ntatoms</span><span class="o">+</span><span class="n">nta</span><span class="p">))</span>
                <span class="n">ntatoms</span> <span class="o">+=</span> <span class="n">nta</span>
            <span class="k">return</span> <span class="n">natoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;number of atoms undefined in site selection&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="MosaicSelection.number_of_sites"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicSelection.number_of_sites">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of sites in the selection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;atom&quot;</span><span class="p">:</span>
            <span class="n">sites_per_atom</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">number_of_sites</span>
                              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">recursive_atom_iterator</span><span class="p">()]</span>
            <span class="c"># If &#39;indices&#39; is an immutable array, N.take crashes due to</span>
            <span class="c"># a numpy bug. Conversion to a plain array prevents this.</span>
            <span class="c"># See Github issue #3758 for numpy/numpy.</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sites_per_atom</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;template_atom&quot;</span><span class="p">:</span>
            <span class="n">sites_per_atom</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">number_of_sites</span>
                              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">recursive_atom_iterator</span><span class="p">()]</span>
            <span class="n">nsites</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ntatoms</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
                <span class="n">nta</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">number_of_atoms</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span> <span class="o">&gt;=</span> <span class="n">ntatoms</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">indices</span> <span class="o">&lt;</span> <span class="n">ntatoms</span><span class="o">+</span><span class="n">nta</span><span class="p">)</span>
                <span class="n">ntatoms</span> <span class="o">+=</span> <span class="n">nta</span>
                <span class="c"># Conversion to plain arrays is required for the same</span>
                <span class="c"># reason as above.</span>
                <span class="n">nsites</span> <span class="o">+=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sites_per_atom</span><span class="p">,</span>
                                               <span class="n">N</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span>
                                                        <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">))))</span>
            <span class="k">return</span> <span class="n">nsites</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;site&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;template_site&quot;</span><span class="p">:</span>
            <span class="n">nsites</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ntsites</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">molecules</span><span class="p">:</span>
                <span class="n">nts</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">number_of_sites</span>
                <span class="n">nsites</span> <span class="o">+=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">indices</span> <span class="o">&gt;=</span> <span class="n">ntsites</span><span class="p">)</span>
                                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">indices</span> <span class="o">&lt;</span> <span class="n">ntsites</span><span class="o">+</span><span class="n">nts</span><span class="p">))</span>
                <span class="n">ntsites</span> <span class="o">+=</span> <span class="n">nts</span>
            <span class="k">return</span> <span class="n">nsites</span>

    <span class="c"># Equivalence test</span>
</div>
<div class="viewcode-block" id="MosaicSelection.validate_equivalence"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicSelection.validate_equivalence">[docs]</a>    <span class="k">def</span> <span class="nf">validate_equivalence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :raises ValueError: if other is not equivalent to self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MosaicSelection</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a selection&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;types differ: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;indices differ&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MosaicSelection.is_equivalent"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicSelection.is_equivalent">[docs]</a>    <span class="k">def</span> <span class="nf">is_equivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for equivalence of Python objects representing</span>
<span class="sd">        Mosaic data. The two objects can belong to different models;</span>
<span class="sd">        only the common API functionality is used for the test.</span>

<span class="sd">        :parameter other: an arbitrary Python object</span>
<span class="sd">        :returns: True if other is equivalent to self</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_equivalence</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># Validation</span>
</div>
    <span class="n">_allowed_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;atom&quot;</span><span class="p">,</span> <span class="s">&quot;site&quot;</span><span class="p">,</span> <span class="s">&quot;template_atom&quot;</span><span class="p">,</span> <span class="s">&quot;template_site&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="MosaicSelection.validate"><a class="viewcode-back" href="../../python_api.html#mosaic.api.MosaicSelection.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that the object satisfies the constraints of the</span>
<span class="sd">        Mosaic data model.</span>

<span class="sd">        :raises ValueError: if the object is not valid Mosaic data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validate_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_types</span><span class="p">,</span> <span class="s">&quot;Selection.type&quot;</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">MosaicUniverse</span><span class="p">,</span> <span class="s">&quot;Selection.universe&quot;</span><span class="p">)</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;atom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_atoms</span><span class="p">,</span>
                     <span class="s">&quot;site&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_sites</span><span class="p">,</span>
                     <span class="s">&quot;template_atom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_template_atoms</span><span class="p">,</span>
                     <span class="s">&quot;template_site&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">number_of_template_sites</span><span class="p">,</span>
                    <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
        <span class="n">validate_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">max_index</span><span class="p">,</span> <span class="s">&quot;Selection.indices&quot;</span><span class="p">)</span>

<span class="c"># Validation functions</span>
</div></div>
<span class="k">def</span> <span class="nf">validate_type</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> must be of type </span><span class="si">%s</span><span class="s"> (is </span><span class="si">%s</span><span class="s">)&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))))</span>


<span class="k">def</span> <span class="nf">validate_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">allowed_values</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">allowed_values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> must be one of </span><span class="si">%s</span><span class="s">&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_values</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">validate_ascii_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">isascii</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;non-ASCII string in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">text</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">validate_label</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">validate_type</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> too long, must be &lt;= 32767 characters&quot;</span> <span class="o">%</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">label</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_allowed_in_labels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;illegal character &#39;</span><span class="si">%s</span><span class="s">&#39; in </span><span class="si">%s</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

<span class="n">_allowed_in_labels</span> <span class="o">=</span> <span class="s">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span> <span class="o">+</span> \
                     <span class="s">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span> <span class="o">+</span> \
                     <span class="s">&#39;0123456789!#$%&amp;?@^_~+-*/=,()[]&#39;</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span>


<span class="k">def</span> <span class="nf">validate_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">allowed_dtypes</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="c"># Don&#39;t check for N.ndarray in order to allow on-disk</span>
    <span class="c"># arrays (HDF5, netCDF)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">a_shape</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">a_dtype</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> must be an array&quot;</span> <span class="o">%</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">a_shape</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> must have shape </span><span class="si">%s</span><span class="s">&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">a_dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_dtypes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot; </span><span class="si">%s</span><span class="s"> must have element type </span><span class="si">%s</span><span class="s">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span>
                           <span class="s">&quot; or &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">allowed_dtypes</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">validate_sequence</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">el_cls</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">additional_tests</span><span class="o">=</span><span class="p">()):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">el_cls</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> must be a sequence of </span><span class="si">%s</span><span class="s"> elements&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">el_cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">test_fn</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">additional_tests</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">test_fn</span><span class="p">(</span><span class="n">el</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">),</span> <span class="n">text</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">validate_indices</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">max_index</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">validate_array</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">uint64</span><span class="p">],</span>
                   <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;index array not 1d&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">indices</span> <span class="o">&gt;=</span> <span class="n">max_index</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;index too large&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;indices not sorted&quot;</span><span class="p">)</span>

<span class="c"># The unit validator accepts a very limited syntax, which</span>
<span class="c"># should be sufficient: a unit is defined by a string of</span>
<span class="c"># unit names with an optional numeric suffix indication a power.</span>
<span class="c"># The unit list can include integers or decimal fractions.</span>
<span class="c">#</span>
<span class="c"># Examples: &quot;nm ps-1&quot; (velocity), &quot;nm2&quot; (area), &quot;kJ mol-1&quot; (energy)</span>
<span class="c">#           &quot;0.1 nm&quot; (length), &quot;60 s&quot; (time)</span>

<span class="k">def</span> <span class="nf">validate_units</span><span class="p">(</span><span class="n">unit_spec</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">validate_type</span><span class="p">(</span><span class="n">unit_spec</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_spec</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="c"># number (integer or decimal fraction)</span>
        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^[1-9][0-9]*$&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^0\.[0-9]+$&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)):</span>
                <span class="k">continue</span>
        <span class="c"># symbol+exponent</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^(?P&lt;symbol&gt;[a-zA-Z]+)([-]?[0-9]+)?$&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;symbol&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_allowed_units</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;invalid unit &#39;</span><span class="si">%s</span><span class="s">&#39; in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">unit_spec</span><span class="p">))</span>

<span class="n">_allowed_units</span> <span class="o">=</span> \
    <span class="p">[</span><span class="s">&quot;pm&quot;</span><span class="p">,</span>   <span class="s">&quot;Ang&quot;</span><span class="p">,</span>  <span class="s">&quot;nm&quot;</span><span class="p">,</span>   <span class="s">&quot;um&quot;</span><span class="p">,</span>   <span class="s">&quot;mm&quot;</span><span class="p">,</span>   <span class="s">&quot;m&quot;</span><span class="p">,</span>    
     <span class="s">&quot;fs&quot;</span><span class="p">,</span>   <span class="s">&quot;ps&quot;</span><span class="p">,</span>   <span class="s">&quot;ns&quot;</span><span class="p">,</span>   <span class="s">&quot;us&quot;</span><span class="p">,</span>   <span class="s">&quot;ms&quot;</span><span class="p">,</span>   <span class="s">&quot;s&quot;</span><span class="p">,</span>    
     <span class="s">&quot;amu&quot;</span><span class="p">,</span>  <span class="s">&quot;g&quot;</span><span class="p">,</span>    <span class="s">&quot;kg&quot;</span><span class="p">,</span>   
     <span class="s">&quot;mol&quot;</span><span class="p">,</span>  
     <span class="s">&quot;J&quot;</span><span class="p">,</span>    <span class="s">&quot;kJ&quot;</span><span class="p">,</span>   <span class="s">&quot;cal&quot;</span><span class="p">,</span>  <span class="s">&quot;kcal&quot;</span><span class="p">,</span> <span class="s">&quot;eV&quot;</span><span class="p">,</span>   
     <span class="s">&quot;K&quot;</span><span class="p">,</span>    
     <span class="s">&quot;Pa&quot;</span><span class="p">,</span>   <span class="s">&quot;kPa&quot;</span><span class="p">,</span>  <span class="s">&quot;MPa&quot;</span><span class="p">,</span>  <span class="s">&quot;GPa&quot;</span><span class="p">,</span>  <span class="s">&quot;atm&quot;</span><span class="p">,</span>  <span class="s">&quot;bar&quot;</span><span class="p">,</span>  <span class="s">&quot;kbar&quot;</span><span class="p">,</span> 
     <span class="s">&quot;e&quot;</span><span class="p">,</span>    <span class="s">&quot;C&quot;</span><span class="p">,</span>    <span class="s">&quot;A&quot;</span><span class="p">,</span>    <span class="s">&quot;V&quot;</span><span class="p">,</span>    
     <span class="s">&quot;rad&quot;</span><span class="p">,</span>  
     <span class="s">&quot;c&quot;</span><span class="p">,</span>    <span class="s">&quot;h&quot;</span><span class="p">,</span>    <span class="s">&quot;me&quot;</span><span class="p">]</span>

<span class="c"># Validation as a test function rather than raising exceptions</span>

<span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html">The API common to all models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.immutable_model">The immutable model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.mutable_model">The mutable model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.array_model">The array model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.hdf5">HDF5 I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.xml_io">XML I/O</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">The file converter <tt class="docutils literal"><span class="pre">mosaic</span></tt></a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_model.html">The Mosaic data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xml.html">Mosaic XML files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdf5.html">Mosaic in HDF5 files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pdb_convention.html">Mosaic PDB convention</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="../../search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             >index</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2013, The Mosaic Community.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>