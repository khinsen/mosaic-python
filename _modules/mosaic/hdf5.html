

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mosaic.hdf5 &mdash; Mosaic Python Library 0.9</title>
    
    <link rel="stylesheet" href="../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Mosaic Python Library 0.9" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">Mosaic Python Library 0.9</a></div>
        <div class="rel">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for mosaic.hdf5</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;HDF5 I/O</span>

<span class="sd">.. moduleauthor:: Konrad Hinsen</span>

<span class="sd">Any model implementing the Mosaic API can be written to a HDF5 file,</span>
<span class="sd">but will be implicitly converted to a :mod:`mosaic.array_model`</span>
<span class="sd">representation.  Data items read from a HDF5 file are always</span>
<span class="sd">represented by an :mod:`mosaic.array_model`.</span>

<span class="sd">The HDF5 storage layout is designed for clarity rather than</span>
<span class="sd">simplicity, the files should be as self-documenting as possible.</span>

<span class="sd">A common pattern for generating an HDF5 file is:</span>

<span class="sd">::</span>

<span class="sd">    with HDF5Store(&#39;molecule.h5&#39;, &#39;w&#39;) as writer:</span>
<span class="sd">       writer.store(&quot;universe&quot;, universe)</span>
<span class="sd">       writer.store(&quot;configuration1&quot;, configuration1)</span>
<span class="sd">       writer.store(&quot;configuration2&quot;, configuration2)</span>

<span class="sd">A common pattern for reading from an HDF5 file is:</span>

<span class="sd">::</span>

<span class="sd">    items = {}</span>
<span class="sd">    for id, data in HDF5Store(&#39;molecule.h5&#39;):</span>
<span class="sd">       items[id] = data</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c">#       Copyright (C) 2013 The Mosaic Development Team</span>
<span class="c">#</span>
<span class="c">#  Distributed under the terms of the BSD License.  The full license is in</span>
<span class="c">#  the file LICENSE.txt, distributed as part of this software.</span>
<span class="c">#-----------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">h5py.h5t</span>
<span class="kn">import</span> <span class="nn">h5py.h5d</span>
<span class="kn">import</span> <span class="nn">h5py.h5s</span>
<span class="kn">import</span> <span class="nn">h5py.version</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>

<span class="kn">import</span> <span class="nn">mosaic.array_model</span>
<span class="kn">import</span> <span class="nn">mosaic.api</span> <span class="kn">as</span> <span class="nn">api</span>
<span class="kn">from</span> <span class="nn">mosaic.utility</span> <span class="kn">import</span> <span class="n">MethodRegister</span>
<span class="kn">from</span> <span class="nn">mosaic.utility</span> <span class="kn">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">mosaic.utility</span> <span class="kn">import</span> <span class="n">isstring</span>
<span class="kn">from</span> <span class="nn">mosaic.utility</span> <span class="kn">import</span> <span class="n">py_str</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">del</span> <span class="n">sys</span>


<span class="k">if</span> <span class="n">h5py</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">hdf5_version_tuple</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;HDF5 version &gt;= 1.8.7 required&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">isstring</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">special_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="nb">bytes</span><span class="p">))</span>
        <span class="n">ds</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">return</span> <span class="n">ds</span>


<div class="viewcode-block" id="HDF5Store"><a class="viewcode-back" href="../../python_api.html#mosaic.hdf5.HDF5Store">[docs]</a><span class="k">class</span> <span class="nc">HDF5Store</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;I/O handler for HDF5 files</span>

<span class="sd">    This class handles the translation of references between Mosaic</span>
<span class="sd">    data items in memory and HDF5 object references in a file. When</span>
<span class="sd">    writing data, references are allowed only to data items that have</span>
<span class="sd">    been written earlier using the same HDF5Store instance.</span>

<span class="sd">    An HDF5Store can be used like a file, in which case it must be</span>
<span class="sd">    closed after the last ``store`` or ``retrieve`` operation, or as a</span>
<span class="sd">    context manager in a with-statement. For reading, it also behaves</span>
<span class="sd">    like an iterator yielding ``(name, data_item)`` pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf5_group_or_filename</span><span class="p">,</span> <span class="n">file_mode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param hdf5_group_or_filename: a group in an open HDF5 file,</span>
<span class="sd">                                       or a string interpreted as a file name</span>
<span class="sd">        :type hdf5_group_or_filename: str or ``h5py.Group``</span>
<span class="sd">        :param file_mode: ``&#39;r&#39;`` or ``&#39;w&#39;``, used only with a filename argument</span>
<span class="sd">        :type file_mode:  str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isstring</span><span class="p">(</span><span class="n">hdf5_group_or_filename</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file_mode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">file_mode</span> <span class="o">=</span> <span class="s">&#39;r&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hdf5_group_or_filename</span><span class="p">,</span> <span class="n">file_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">api</span><span class="o">.</span><span class="n">validate_value</span><span class="p">(</span><span class="n">file_mode</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">],</span> <span class="s">&quot;file_mode&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">hdf5_group_or_filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_map</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_map</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span> <span class="o">=</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">array_model</span><span class="o">.</span><span class="n">Factory</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">storage_handler</span> <span class="o">=</span> <span class="n">MethodRegister</span><span class="p">()</span>

<div class="viewcode-block" id="HDF5Store.store"><a class="viewcode-back" href="../../python_api.html#mosaic.hdf5.HDF5Store.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param path: a HDF5 path, relative to the group used by the HDF5Store</span>
<span class="sd">        :type path:  str</span>
<span class="sd">        :param data: a Mosaic data item</span>
<span class="sd">        :type data:  :class:`mosaic.api.MosaicDataItem`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api</span><span class="o">.</span><span class="n">validate_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&quot;path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;/&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;absolute paths not allowed&quot;</span><span class="p">)</span>
        <span class="n">api</span><span class="o">.</span><span class="n">validate_type</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">api</span><span class="o">.</span><span class="n">MosaicDataItem</span><span class="p">,</span> <span class="s">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_handler</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Storage of </span><span class="si">%s</span><span class="s"> not yet implemented&quot;</span>
                            <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_data_item</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HDF5Store.retrieve"><a class="viewcode-back" href="../../python_api.html#mosaic.hdf5.HDF5Store.retrieve">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_or_node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param path_or_node: a HDF5 path, relative to the group used by</span>
<span class="sd">                             the HDF5Store, or an HDF5 node</span>
<span class="sd">        :type path_or_node:  str or h5py.Node</span>
<span class="sd">        :returns: a Mosaic data item</span>
<span class="sd">        :rtype:  :class:`mosaic.api.MosaicDataItem`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_node</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5r</span><span class="o">.</span><span class="n">Reference</span><span class="p">):</span>
            <span class="n">path_or_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="n">path_or_node</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_node</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path_or_node</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Group, Dataset, or classes with the same interface</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path_or_node</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="p">):]</span>
                <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;path name not inside root group&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">py_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_stamp</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Undefined node type </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_handler</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Retrieval of node type </span><span class="si">%s</span><span class="s"> not yet implemented&quot;</span>
                             <span class="o">%</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_data_item</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</div>
    <span class="n">_node_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;universe&#39;</span><span class="p">,</span> <span class="s">&#39;configuration&#39;</span><span class="p">,</span> <span class="s">&#39;property&#39;</span><span class="p">,</span> <span class="s">&#39;label&#39;</span><span class="p">,</span>
                   <span class="s">&#39;selection&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># First pass: universes</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATA_MODEL&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;MOSAIC&#39;</span><span class="p">)</span> \
               <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;MOSAIC_DATA_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;universe&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c"># Second pass: anything else</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATA_MODEL&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;MOSAIC&#39;</span><span class="p">)</span> \
               <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;MOSAIC_DATA_TYPE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;universe&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recursive_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="c"># First pass: universes</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATA_MODEL&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;MOSAIC&#39;</span><span class="p">)</span> \
               <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;MOSAIC_DATA_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;universe&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">gname</span><span class="p">,</span> <span class="n">gnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_iterator</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">name</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">gname</span><span class="p">,</span> <span class="n">gnode</span>
        <span class="c"># Second pass: anything else</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATA_MODEL&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;MOSAIC&#39;</span><span class="p">)</span> \
               <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;MOSAIC_DATA_TYPE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;universe&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">gname</span><span class="p">,</span> <span class="n">gnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_iterator</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">name</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">gname</span><span class="p">,</span> <span class="n">gnode</span>

    <span class="k">def</span> <span class="nf">_stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;DATA_MODEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;MOSAIC&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;DATA_MODEL_MAJOR_VERSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">MOSAIC_VERSION</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;DATA_MODEL_MINOR_VERSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">MOSAIC_VERSION</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;MOSAIC_DATA_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;DATA_MODEL&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ascii</span><span class="p">(</span><span class="s">&#39;MOSAIC&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Node </span><span class="si">%s</span><span class="s"> not an Mosaic data item&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;DATA_MODEL_MAJOR_VERSION&#39;</span><span class="p">],</span>
                   <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;DATA_MODEL_MINOR_VERSION&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">api</span><span class="o">.</span><span class="n">MOSAIC_VERSION</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
           <span class="ow">or</span> <span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">api</span><span class="o">.</span><span class="n">MOSAIC_VERSION</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;HDF5 data is for version </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">, &quot;</span>
                             <span class="s">&quot;software is version </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">version</span> <span class="o">+</span> <span class="n">api</span><span class="o">.</span><span class="n">MOSAIC_VERSION</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;MOSAIC_DATA_TYPE&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_register_data_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data_item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_map</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_map</span><span class="p">[</span><span class="n">data_item</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data_item</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c">#</span>
    <span class="c"># Store data in HDF5 file</span>
    <span class="c">#</span>
    <span class="nd">@storage_handler</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">MosaicUniverse</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_store_universe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">universe</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># ActivePapers support</span>
            <span class="n">group</span><span class="o">.</span><span class="n">mark_as_data_item</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stamp</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;universe&#39;</span><span class="p">)</span>

        <span class="c"># Convert the universe to an array_model</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>

        <span class="c"># Create HDF5 datasets</span>
        <span class="n">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;cell_shape&#39;</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">universe</span><span class="o">.</span><span class="n">cell_shape</span><span class="p">)</span>
        <span class="n">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;symmetry_transformations&#39;</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">_symmetry_transformations</span><span class="p">))</span>
        <span class="n">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;convention&#39;</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">universe</span><span class="o">.</span><span class="n">convention</span><span class="p">)</span>
        <span class="n">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;fragments&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">universe</span><span class="o">.</span><span class="n">_fragment_array</span><span class="p">)</span>
        <span class="n">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;atoms&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">universe</span><span class="o">.</span><span class="n">_atom_array</span><span class="p">)</span>
        <span class="n">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;bonds&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">universe</span><span class="o">.</span><span class="n">_bond_array</span><span class="p">)</span>
        <span class="n">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;molecules&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">universe</span><span class="o">.</span><span class="n">_molecule_array</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">_polymer_array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;polymers&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">universe</span><span class="o">.</span><span class="n">_polymer_array</span><span class="p">)</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">_symbols</span>
        <span class="n">symbol_table</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="s">&#39;symbols&#39;</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">),),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">special_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="nb">bytes</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symbols</span><span class="p">):</span>
            <span class="n">symbol_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="nd">@storage_handler</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">MosaicConfiguration</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_store_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">universe</span>
        <span class="n">universe_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">universe_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;universe must be stored first&quot;</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># ActivePapers support</span>
            <span class="n">group</span><span class="o">.</span><span class="n">mark_as_data_item</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stamp</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;configuration&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;universe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="n">universe_path</span><span class="p">]</span><span class="o">.</span><span class="n">ref</span>
        <span class="n">ncellparams</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">cell_parameter_array_shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncellparams</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">create_dataset</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;cell_parameters&#39;</span><span class="p">,</span>
                           <span class="n">data</span><span class="o">=</span><span class="n">configuration</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="s">&#39;positions&#39;</span><span class="p">,</span>
                                          <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">),),</span>
                                          <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;(3,)f</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="c"># There doesn&#39;t seem to be any way to write this array</span>
        <span class="c"># using high-level operations, so we use the low-level access.</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5t</span><span class="o">.</span><span class="n">py_create</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">mspace</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5s</span><span class="o">.</span><span class="n">create_simple</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">fspace</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">get_space</span><span class="p">()</span>
        <span class="n">positions</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mspace</span><span class="p">,</span> <span class="n">fspace</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">mtype</span><span class="p">)</span>

    <span class="nd">@storage_handler</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">MosaicProperty</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_store_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">universe</span>
        <span class="n">universe_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">universe_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;universe must be stored first&quot;</span><span class="p">)</span>
        <span class="n">element_shape</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">element_shape</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="nb">property</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">element_shape</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="nb">property</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                       <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">),),</span>
                                       <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stamp</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s">&#39;property&#39;</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;universe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="n">universe_path</span><span class="p">]</span><span class="o">.</span><span class="n">ref</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="nb">property</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="nb">property</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;property_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="nb">property</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="c"># There doesn&#39;t seem to be any way to write this array</span>
        <span class="c"># using high-level operations, so we use the low-level access.</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5t</span><span class="o">.</span><span class="n">py_create</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">mspace</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">h5s</span><span class="o">.</span><span class="n">create_simple</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">fspace</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">get_space</span><span class="p">()</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mspace</span><span class="p">,</span> <span class="n">fspace</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">mtype</span><span class="p">)</span>

    <span class="nd">@storage_handler</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">MosaicLabel</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_store_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">universe</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">universe_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">universe_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;universe must be stored first&quot;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">label</span><span class="o">.</span><span class="n">_string_array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stamp</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s">&#39;label&#39;</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;universe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="n">universe_path</span><span class="p">]</span><span class="o">.</span><span class="n">ref</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;label_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

    <span class="nd">@storage_handler</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">MosaicSelection</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_store_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">universe</span>
        <span class="n">universe_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">universe_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;universe must be stored first&quot;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
                            <span class="n">N</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">indices</span><span class="p">))</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;universe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="n">universe_path</span><span class="p">]</span><span class="o">.</span><span class="n">ref</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;selection_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stamp</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s">&#39;selection&#39;</span><span class="p">)</span>

    <span class="c">#</span>
    <span class="c"># Retrieve data from HDF5 file</span>
    <span class="c">#</span>
    <span class="nd">@storage_handler</span><span class="p">(</span><span class="s">&#39;universe&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_retrieve_universe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c"># Work around a restriction/bug in h5py that prevents reading</span>
        <span class="c"># arrays of length zero.</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s">&#39;symmetry_transformations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">&#39;symmetry_transformations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s">&#39;symmetry_transformations&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">array_model</span><span class="o">.</span><span class="n">Universe</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span>
                        <span class="n">node</span><span class="p">[</span><span class="s">&#39;atoms&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">],</span>
                        <span class="n">node</span><span class="p">[</span><span class="s">&#39;bonds&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">],</span>
                        <span class="n">node</span><span class="p">[</span><span class="s">&#39;fragments&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">],</span>
                        <span class="n">node</span><span class="p">[</span><span class="s">&#39;polymers&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s">&#39;polymers&#39;</span> <span class="ow">in</span> <span class="n">node</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                        <span class="n">node</span><span class="p">[</span><span class="s">&#39;molecules&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">],</span>
                        <span class="nb">tuple</span><span class="p">(</span><span class="n">py_str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s">&#39;symbols&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]),</span>
                        <span class="n">st</span><span class="p">,</span>
                        <span class="n">py_str</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s">&#39;cell_shape&#39;</span><span class="p">][()]),</span>
                        <span class="n">py_str</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s">&#39;convention&#39;</span><span class="p">][()]))</span>

    <span class="nd">@storage_handler</span><span class="p">(</span><span class="s">&#39;configuration&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_retrieve_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;universe&#39;</span><span class="p">])</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s">&#39;positions&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;cell_parameters&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s">&#39;cell_parameters&#39;</span><span class="p">]</span>
            <span class="n">cell_parameters</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">cell_parameters</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">N</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">cell_parameter_array_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">cell_parameters</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">cell_parameter_array_shape</span><span class="p">,</span>
                                      <span class="n">positions</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">array_model</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span>
                                                <span class="n">cell_parameters</span><span class="p">)</span>

    <span class="nd">@storage_handler</span><span class="p">(</span><span class="s">&#39;property&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_retrieve_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;universe&#39;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">py_str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">py_str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;units&#39;</span><span class="p">])</span>
        <span class="n">property_type</span> <span class="o">=</span> <span class="n">py_str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;property_type&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">array_model</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span>
                                           <span class="n">data</span><span class="p">,</span> <span class="n">property_type</span><span class="p">)</span>

    <span class="nd">@storage_handler</span><span class="p">(</span><span class="s">&#39;label&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_retrieve_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;universe&#39;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">py_str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">label_type</span> <span class="o">=</span> <span class="n">py_str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;label_type&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">array_model</span><span class="o">.</span><span class="n">Label</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                                    <span class="n">data</span><span class="p">,</span> <span class="n">label_type</span><span class="p">)</span>

    <span class="nd">@storage_handler</span><span class="p">(</span><span class="s">&#39;selection&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_retrieve_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;universe&#39;</span><span class="p">])</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="n">selection_type</span> <span class="o">=</span> <span class="n">py_str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;selection_type&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">array_model</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span>
                                            <span class="n">selection_type</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html">The API common to all models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.immutable_model">The immutable model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.mutable_model">The mutable model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.array_model">The array model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.hdf5">HDF5 I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html#module-mosaic.xml_io">XML I/O</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">The file converter <tt class="docutils literal"><span class="pre">mosaic</span></tt></a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_model.html">The Mosaic data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xml.html">Mosaic XML files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdf5.html">Mosaic in HDF5 files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pdb_convention.html">Mosaic PDB convention</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="../../search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             >index</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2013, The Mosaic Community.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>